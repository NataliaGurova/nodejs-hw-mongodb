–ö—Ä–æ–∫ 1

–°—Ç–≤–æ—Ä—ñ—Ç—å –≥—ñ–ª–∫—É hw6-email-and-images –∑ –≥—ñ–ª–∫–∏ hw5-auth —ñ –≤–∏–∫–æ–Ω—É–π—Ç–µ —Ü–µ –∑–∞–≤–¥–∞–Ω–Ω—è –≤ –≥—ñ–ª—Ü—ñ hw6-email-and-images.



–ö—Ä–æ–∫ 2

–°—Ç–≤–æ—Ä—ñ—Ç—å –∞–∫–∞—É–Ω—Ç –Ω–∞ brevo.com. –¶–µ–π —Å–µ—Ä–≤—ñ—Å –±—É–¥–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∏–π –¥–ª—è –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –ø–æ –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ñ–π –ø–æ—à—Ç—ñ.



–ö—Ä–æ–∫ 3

–°—Ç–≤–æ—Ä—ñ—Ç—å —Ä–æ—É—Ç POST /auth/send-reset-email. –í body –≤—ñ–Ω –º–∞—î –ø—Ä–∏–π–º–∞—Ç–∏ –µ–º–µ–π–ª –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (–≤–ª–∞—Å—Ç–∏–≤—ñ—Å—Ç—å email).

–ó–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –ø–∞–∫–µ—Ç—É nodemailer (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –∫—Ä–µ–¥–∏—Ç–∏ –∑ Brevo –¥–ª—è –ø—ñ–¥ º—î–¥–Ω–∞–Ω–Ω—è –¥–æ SMTP-—Å–µ—Ä–≤–µ—Ä—É) –æ—Ä–≥–∞–Ω—ñ–∑—É–π—Ç–µ –≤—ñ–¥–ø—Ä–∞–≤–∫—É –µ–º–µ–π–ª–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É –∑ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º –¥–ª—è —Å–∫–∏–¥—É –ø–∞—Ä–æ–ª—é.

–ü–æ—Å–∏–ª–∞–Ω–Ω—è –º–∞—î —Å–∫–ª–∞–¥–∞—Ç–∏—Å—è –∑:

–î–æ–º–µ–Ω–∞, –Ω–∞ —è–∫–æ–º—É –±—É–¥–µ –∑–Ω–∞—Ö–æ–¥–∏—Ç–∏—Å—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –Ω–∞—à–æ–≥–æ –¥–æ–¥–∞—Ç–∫—É (–≤–∑—è—Ç–∏ —ñ–∑ –∑–º—ñ–Ω–Ω–∏—Ö –æ—Ç–æ—á–µ–Ω–Ω—è);
–®–ª—è—Ö—É –¥–æ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –∑ —Å–∫–∏–¥–æ–º –ø–∞—Ä–æ–ª—é - /reset-password;
Query-–ø–∞—Ä–∞–º–µ—Ç–µ—Ä—É token, —è–∫–∏–π –¥–æ—Ä—ñ–≤–Ω—é—î JWT —Ç–æ–∫–µ–Ω—É, —â–æ –±—É–≤ —Å—Ç–≤–æ—Ä–µ–Ω–∏–π –Ω–∞ –±–µ–∫–µ–Ω–¥—ñ —ñ –º—ñ—Å—Ç–∏—Ç—å email –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞. –¢–µ—Ä–º—ñ–Ω –∂–∏—Ç—Ç—è —Ç–æ–∫–µ–Ω—É –≤—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å 5 —Ö–≤–∏–ª–∏–Ω.


–ó–∞–≥–∞–ª—å–Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –≤–∏–≥–ª—è–¥–∞—Ç–∏–º–µ —Ç–∞–∫:

https://<your-frontend-domain>/reset-password?token=<jwt-token>

–ù–∞ —Ü—å–æ–º—É –µ—Ç–∞–ø—ñ —É—Å—ñ —á—É—Ç–ª–∏–≤—ñ –¥–∞–Ω—ñ –º–∞—é—Ç—å –±—É—Ç–∏ –≤–∏–Ω–µ—Å–µ–Ω—ñ –≤ –∑–º—ñ–Ω–Ω—ñ –æ—Ç–æ—á–µ–Ω–Ω—è.


https://www.brevo.com/
–î–∞–Ω—ñ –¥–ª—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ Brevo:

SMTP_HOST
SMTP_PORT
SMTP_USER
SMTP_PASSWORD
SMTP_FROM


–ó–º—ñ–Ω–Ω–∞, —è–∫–∞ –±—É–¥–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏—Å—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –ø—ñ–¥–ø–∏—Å—É –Ω–∞—à–æ–≥–æ —Ç–æ–∫–µ–Ω—É:

JWT_SECRET


–î–æ–º–µ–Ω, –Ω–∞ —è–∫–æ–º—É –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –Ω–∞—à–æ–≥–æ –¥–æ–¥–∞—Ç–∫—É:

APP_DOMAIN (–ø–æ–∫–∏ —â–æ –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –∑—ñ –∑–Ω–∞—á–µ–Ω–Ω—è–º ‚Äúhttp://localhost:3000/auth‚Äù)
–û–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ –¥–æ–¥–∞–π—Ç–µ —Ü—ñ –∑–º—ñ–Ω–Ω—ñ –æ—Ç–æ—á–µ–Ω–Ω—è –¥–æ —Ñ–∞–π–ª—É .env.example.


–û–±—Ä–æ–±—ñ—Ç—å —Ç–∞–∫—ñ –ø–æ–º–∏–ª–∫–∏ —è–∫:

–ø–æ–º–∏–ª–∫–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó body (–≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ middleware validateBody);
–≤—ñ–¥—Å—É—Ç–Ω—ñ–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤ –±–∞–∑—ñ (–∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é http-errors —Å—Ç–≤–æ—Ä—ñ—Ç—å –ø–æ–º–∏–ª–∫—É –∑—ñ —Å—Ç–∞—Ç—É—Å–æ–º 404 —ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º "User not found!");
–Ω–µ –≤–¥–∞–ª–æ—Å—è –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –ª–∏—Å—Ç–∞ (–∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é http-errors —Å—Ç–≤–æ—Ä—ñ—Ç—å –ø–æ–º–∏–ª–∫—É –∑—ñ —Å—Ç–∞—Ç—É—Å–æ–º 500 —ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º "Failed to send the email, please try again later.").


–£ —Ä–∞–∑—ñ —É—Å–ø—ñ—à–Ω–æ–≥–æ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è –ª–∏—Å—Ç–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å —Å–µ—Ä–≤–µ—Ä–∞ –º–∞—î –±—É—Ç–∏ –∑—ñ —Å—Ç–∞—Ç—É—Å–æ–º 200 —Ç–∞ –º—ñ—Å—Ç–∏—Ç–∏ –æ–±‚Äô—î–∫—Ç –∑ –Ω–∞—Å—Ç—É–ø–Ω–∏–º–∏ –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—è–º–∏:

   {
       status: 200,
       message: "Reset password email has been successfully sent.",
       data: {}
   }



–ö—Ä–æ–∫ 4



–°—Ç–≤–æ—Ä—ñ—Ç—å —Ä–æ—É—Ç POST /auth/reset-pwd.

–í body –≤—ñ–Ω –º–∞—î –ø—Ä–∏–π–º–∞—Ç–∏:

–≤–ª–∞—Å—Ç–∏–≤—ñ—Å—Ç—å token - JWT —Ç–æ–∫–µ–Ω, —è–∫–∏–π –±—É–≤ –ø–µ—Ä–µ–¥–∞–Ω–∏–π —É –ø–æ—Å–∏–ª–∞–Ω–Ω—è –¥–ª—è —Å–∫–∏–¥—É –ø–∞—Ä–æ–ª—é –≤ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–º—É –∫—Ä–æ—Ü—ñ;
–≤–ª–∞—Å—Ç–∏–≤—ñ—Å—Ç—å password - –Ω–æ–≤–∏–π –ø–∞—Ä–æ–ª—å.
–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –æ—Ç—Ä–∏–º–∞–Ω–∏–π –≤ body JWT —Ç–æ–∫–µ–Ω –¥—ñ–π—Å–Ω–∏–π —ñ –Ω–µ –ø—Ä–æ—Ç–µ—Ä–º—ñ–Ω–æ–≤–∞–Ω–∏–π.



–û–±—Ä–æ–±—ñ—Ç—å —Ç–∞–∫—ñ –ø–æ–º–∏–ª–∫–∏ —è–∫:

–ø–æ–º–∏–ª–∫–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó body (–≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ middleware validateBody);
–≤—ñ–¥—Å—É—Ç–Ω—ñ–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤ –±–∞–∑—ñ (–∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é http-errors —Å—Ç–≤–æ—Ä—ñ—Ç—å –ø–æ–º–∏–ª–∫—É –∑—ñ —Å—Ç–∞—Ç—É—Å–æ–º 404 —ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º "User not found!");
–ø—Ä–æ—Ç–µ—Ä–º—ñ–Ω–æ–≤–∞–Ω–∏–π –∞–±–æ –ø–æ—à–∫–æ–¥–∂–µ–Ω–∏–π —Ç–æ–∫–µ–Ω (–ø–µ—Ä–µ–¥–∞–π—Ç–µ –¥–æ –≤–∏–∫–ª–∏–∫—É createHttpError —Å—Ç–∞—Ç—É—Å 401 —ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è "Token is expired or invalid.").


–Ø–∫—â–æ –∑ —Ç–æ–∫–µ–Ω–æ–º –≤—Å–µ –¥–æ–±—Ä–µ, —Ç–æ –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑ email, —â–æ –º—ñ—Å—Ç–∏—Ç—å—Å—è –≤ —Ç–æ–∫–µ–Ω—ñ:

–æ–Ω–æ–≤—ñ—Ç—å –ø–∞—Ä–æ–ª—å;
–≤–∏–¥–∞–ª—ñ—Ç—å –ø–æ—Ç–æ—á–Ω—É —Å–µ—Å—ñ—é –¥–ª—è —Ü—å–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.


–£ —Ä–∞–∑—ñ —É—Å–ø—ñ—à–Ω–æ—ó –∑–∞–º—ñ–Ω–∏ –ø–∞—Ä–æ–ª—é –≤—ñ–¥–ø–æ–≤—ñ–¥—å —Å–µ—Ä–≤–µ—Ä–∞ –º–∞—î –±—É—Ç–∏ –∑—ñ —Å—Ç–∞—Ç—É—Å–æ–º 200 —Ç–∞ –º—ñ—Å—Ç–∏—Ç–∏ –æ–±‚Äô—î–∫—Ç –∑ –Ω–∞—Å—Ç—É–ø–Ω–∏–º–∏ –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—è–º–∏:

   {
       status: 200,
       message: "Password has been successfully reset.",
       data: {}
   }



–ö—Ä–æ–∫ 5

–ó–∞—Ä–µ—î—Å—Ç—Ä—É–π—Ç–µ—Å—å –Ω–∞ Cloudinary.



–ö—Ä–æ–∫ 6

–†–æ–∑—à–∏—Ä—Ç–µ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª –º–æ–∂–ª–∏–≤—ñ—Å—Ç—é –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—ñ—ó –¥–ª—è —Ä–æ—É—Ç—ñ–≤:

POST /contacts
PATCH /contacts/:contactId
–î–æ–¥–∞–π—Ç–µ –ø—ñ–¥—Ç—Ä–∏–º–∫—É Content-Type: multipart/formdata –¥–ª—è —Ü–∏—Ö –µ–Ω–¥–ø–æ—ñ–Ω—Ç—ñ–≤.
–î–æ–¥–∞–π—Ç–µ –ø–æ–ª–µ photo —Ç–∏–ø—É String –≤ –º–æ–¥–µ–ª—ñ Contact.
–î–æ–¥–∞–π—Ç–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤ –Ω–∞ cloudinary. –ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Ñ–∞–π–ª —Ñ–æ—Ç–æ –∑–∞–ø–∏—à—ñ—Ç—å –≤ –±–∞–∑—É —É –ø–æ–ª–µ photo. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –≤ —É—Å—ñ—Ö –µ–Ω–¥–ø–æ—ñ–Ω—Ç–∞—Ö, –¥–µ —î —Ä–æ–±–æ—Ç–∞ –∑ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏, –ø—Ä–∏—Å—É—Ç–Ω—è –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Ñ–æ—Ç–æ.


–ö—Ä–æ–∫ 7

–ü–æ–º—ñ–Ω—è–π—Ç–µ –≥—ñ–ª–∫—É, –∑ —è–∫–æ—ó –∑–∞—Ä–∞–∑ –¥–µ–ø–ª–æ—ó—Ç—å—Å—è –≤–∞—à –ø—Ä–æ—î–∫—Ç –Ω–∞ render.com, –Ω–∞ hw6-email-and-images. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –∑–º—ñ–Ω–∏ —É—Å–ø—ñ—à–Ω–æ –∑–∞–¥–µ–ø–ª–æ—î–Ω—ñ.

–¶–µ –∑–∞–≤–¥–∞–Ω–Ω—è –¥–æ–ø–æ–º–æ–∂–µ –≤–∞–º —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∑—Ä—É—á–Ω–∏–π —Ç–∞ –±–µ–∑–ø–µ—á–Ω–∏–π –º–µ—Ö–∞–Ω—ñ–∑–º –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫–∏–º–∏ –ø–∞—Ä–æ–ª—è–º–∏ —Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è–º –∑–æ–±—Ä–∞–∂–µ–Ω—å. –£—Å–ø—ñ—Ö—ñ–≤ —É –≤–∏–∫–æ–Ω–∞–Ω–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è! üöÄ
================================

// src/services/auth.js

import jwt from 'jsonwebtoken';

import { SMTP } from '../constants/index.js';
import { env } from '../utils/env.js';
import { sendEmail } from '../utils/sendMail.js';

export const requestResetToken = async (email) => {
  const user = await UsersCollection.findOne({ email });
  if (!user) {
    throw createHttpError(404, 'User not found');
  }
  const resetToken = jwt.sign(
    {
      sub: user._id,
      email,
    },
    env('JWT_SECRET'),
    {
      expiresIn: '15m',
    },
  );

  await sendEmail({
    from: env(SMTP.SMTP_FROM),
    to: email,
    subject: 'Reset your password',
    html: `<p>Click <a href="${resetToken}">here</a> to reset your password!</p>`,
  });
};
=================

// src/services/auth.js

import handlebars from 'handlebars';
import path from 'node:path';
import fs from 'node:fs/promises';

/* –Ü–Ω—à–∏–π –∫–æ–¥ —Ñ–∞–π–ª—É */

export const requestResetToken = async (email) => {
  const user = await UsersCollection.findOne({ email });
  if (!user) {
    throw createHttpError(404, 'User not found');
  }
  const resetToken = jwt.sign(
    {
      sub: user._id,
      email,
    },
    env('JWT_SECRET'),
    {
      expiresIn: '15m',
    },
  );

  const resetPasswordTemplatePath = path.join(
    TEMPLATES_DIR,
    'reset-password-email.html',
  );

  const templateSource = (
    await fs.readFile(resetPasswordTemplatePath)
  ).toString();

  const template = handlebars.compile(templateSource);
  const html = template({
    name: user.name,
    link: `${env('APP_DOMAIN')}/reset-password?token=${resetToken}`,
  });

  await sendEmail({
    from: env(SMTP.SMTP_FROM),
    to: email,
    subject: 'Reset your password',
    html,
  });
};
